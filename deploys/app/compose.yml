# app stack
version: "3.8"
services:
  # discord
  sfs-discord-server:
    image: ghcr.io/feato-org/support-feato-system:main
    environment:
      - DISCORD_TOKEN
      - GUILD_IDS
      - APP_MODE
      - NOTIFY_CHANNEL_ID
    networks:
      - system_fluent-network
    deploy:
      resources:
        limits:
          memory: 20M
      restart_policy:
        delay: 15s
    logging:
      driver: fluentd
      options:
        tag: "sfs_discord_server_log"
        fluentd-async: "true"

  # minecraft
  minecraft-proxy:
    image: itzg/bungeecord
    environment:
      TYPE: VELOCITY
      MEMORY: ""
      JVM_XX_OPTS: "-XX:MaxRAMPercentage=75"
      ICON: https://photo.feato.jp/_data/i/upload/2023/06/24/20230624012009-7add3e01-xl.png
      PLUGINS: https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/velocity,https://download.geysermc.org/v2/projects/floodgate/versions/latest/builds/latest/downloads/velocity
    ports:
      - "25565:25577"
      - "19132:19132/udp"
    secrets:
      - forwarding_secret
    volumes:
      - ../../minecraft-proxy/server:/server
      - ../../minecraft-proxy/plugins:/plguins
      - /extras/texturepacks:/plguins/Geyser-Spigot/packs
      - ../../minecraft-proxy/config:/config
    networks:
      - minecraft-network
      - system_fluent-network
    deploy:
      resources:
        limits:
          memory: 6G
      restart_policy:
        delay: 15s
    logging:
      options:
        max-size: 10m
    # logging:
    #   driver: fluentd
    #   options:
    #     fluentd-address: "fluent-bit:24224"
    #     tag: "minecraft_proxy_log"

  minecraft-spigot-server:
    image: itzg/minecraft-server:java21
    environment:
      ONLINE_MODE: "FALSE"
      MEMORY:
      JVM_XX_OPTS: "-XX:MaxRAMPercentage=75"
      TYPE: SPIGOT
      USE_AIKAR_FLAGS: "TRUE"
      EULA: "TRUE"
      VERSION: LATEST
      GAMEMODE: survival
      DIFFICULTY: normal
      SERVER_NAME: FEATO
      SPAWN_PROTECTION: 0
      PLAYER_IDLE_TIMEOUT: 90
      VIEW_DISTANCE: 14
      SIMULATION_DISTANCE: 8
      TZ: Asia/Tokyo
      # TreeAssist,Simply Farming,FarmProtect,BetterChairs Remastered,new-new-gods,DualHorse
      SPIGET_RESOURCES: "67436,110400,87480,84809,89188,99663"
      PLUGINS_FILE: /extras/plugins.txt
      DATAPACKS: /extras/datapacks
      # RESOURCE_PACK: /extras/resourcepack
      LOG_TIMESTAMP: "TRUE"
      TUNE_VIRTUALIZED: "TRUE"
      TUNE_NURSERY_SIZES: "TRUE"
      GUI: "FALSE"
      ICON: https://photo.feato.jp/_data/i/upload/2023/06/24/20230624012009-7add3e01-xl.png
      SEED: ""
      RESOURCE_PACK_ENFORCE: "TRUE"
      ENFORCE_SECURE_PROFILE: "FALSE"
      SPIGOT_DOWNLOAD_URL: https://storage.feato.jp/index.php/s/MkLFA4XBnfcs5ic/download/spigot-1.21.jar
    expose:
      - "25565"
    volumes:
      - ../../minecraft/java/data:/data
      # plugins download
      - ../../minecraft/java/plugins.txt:/extras/plugins.txt:ro
      # - /extras/plugins:/plugins
      # datapack
      - /extras/datapacks:/extras/datapacks
      # resourcepack
      # - /extras/resourcepack:/extras/resourcepack
      # config
      - ../../minecraft/java/config:/config
    networks:
      - minecraft-network
      - nginx-network
    depends_on:
      - fluent-bit
    deploy:
      resources:
        limits:
          memory: 6G
      restart_policy:
        delay: 15s
    logging:
      options:
        max-size: 10m
    # logging:
    #   driver: fluentd
    #   options:
    #     tag: "minecraft_server_log"

  minecraft-monitor:
    image: itzg/mc-monitor
    command: export-for-prometheus
    environment:
      EXPORT_SERVERS: minecraft-spigot-server
    depends_on:
      - minecraft-spigot-server

  # Webç³»
  nginx:
    image: nginx:1.27.0
    command: '/bin/sh -c ''while :; do sleep 20d & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
    ports:
      - 80:80
      - 443:443
    environment:
      TZ: Asia/Tokyo
      PORTAINER_URL:
    volumes:
      - type: bind
        source: ../../nginx/conf.d
        target: /etc/nginx/conf.d
        read_only: true
      - type: bind
        source: ../../nginx/templates
        target: /etc/nginx/templates
        read_only: true
      - type: bind
        source: ../../nginx/sites-available
        target: /etc/nginx/sites-available
        read_only: true
      - type: bind
        source: ../../nginx/sites-enabled
        target: /etc/nginx/sites-enabled
        read_only: true
      - type: bind
        source: ../../nginx/html
        target: /usr/share/nginx/html
        read_only: true
      - certs:/etc/letsencrypt:ro
    networks:
      - nginx-network
      - cert-network
      - system_fluent-network
    logging:
      driver: fluentd
      options:
        tag: "nginx_log"
        fluentd-async: "true"
  certbot:
    image: certbot/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 10d & wait $${!}; done;'"
    volumes:
      - certs:/etc/letsencrypt
    networks:
      - cert-network
      - system_fluent-network
    logging:
      driver: fluentd
      options:
        tag: "certbot_log"
        fluentd-async: "true"

volumes:
  certs: {}

secrets:
  forwarding_secret:
    external: true

networks:
  system_fluent-network:
    external: true
  nginx-network:
    attachable: true
  cert-network:
    attachable: false
  minecraft-network:
    attachable: false
