[SERVICE]
  Parsers_File parsers.conf

[INPUT]
  Name              forward
  Listen            0.0.0.0
  Port              24224

[INPUT]
  Name prometheus_scrape
  Tag minecraft_metrics
  Host minecraft-monitor
  Port 8080
  Scrape_interval 30s

[INPUT]
  Name prometheus_scrape
  Tag cadvisor_metrics
  Host cadvisor
  Port 8080
  Scrape_interval 30s

[INPUT]
  Name            node_exporter_metrics
  Tag             node_metrics
  Scrape_interval 30

[INPUT]
  Name  docker_events
  Tag   docker_event

[FILTER]
  Name      parser
  Match     docker.*
  Key_Name  log
  Parser    docker

[FILTER]
  Name  rewrite_tag
  Match minecraft-server
  Rule  $log (emerg|alert|crit|err|fail|ERR) notify.error true

[FILTER]
  Name  rewrite_tag
  Match minecraft-server
  Rule  $log ((joined|left)\sthe\sgame) notify.login_and_logout true

[FILTER]
  Name rewrite_tag
  Match docker_event
  Rule $message \"status\":\"(oom|kill|die|stop|restart|start)\" notify.container_event true

[FILTER]
  Name          record_modifier
  Match         notify.login_and_logout
  Allowlist_key log

[OUTPUT]
  Name    slack
  Match   notify.error
  Webhook ${ERROR_WEBHOOK_URL}

[OUTPUT]
  Name    slack
  Match   notify.login_and_logout
  Webhook ${NOTIFY_WEBHOOK_URL}

[OUTPUT]
  name        prometheus_remote_write
  host        prometheus-prod-18-prod-ap-southeast-0.grafana.net
  match       *_metrics
  uri         /api/prom/push
  http_user   ${PROM_USER_ID}
  http_passwd ${GRAFANA_API_KEY}
  add_label   app_mode ${APP_MODE}

[OUTPUT]
  Name        loki
  Match       docker.*
  Host        logs-prod-011.grafana.net
  port        443
  tls         on
  tls.verify  on
  http_user   ${LOKI_USER_ID}
  http_passwd ${GRAFANA_API_KEY}
  labels      app_mode=${APP_MODE}

[OUTPUT]
  Name slack
  Match notify.container_event
  Webhook ${ERROR_WEBHOOK_URL}
